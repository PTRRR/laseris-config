# ===================================
# TRAEFIK INGRESS CONFIGURATION
# ===================================

---
# ClusterIssuer for Let's Encrypt SSL
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod
spec:
  acme:
    server: https://acme-v02.api.letsencrypt.org/directory
    email: pietro.alberti@bluewin.ch
    privateKeySecretRef:
      name: letsencrypt-prod
    solvers:
      - http01:
          ingress:
            class: traefik

---
# Endpoints for external laseris.ch proxy
# Note: ArgoCD excludes Endpoints by default - this resource must be applied manually
apiVersion: v1
kind: Endpoints
metadata:
  name: laseris-ch-external
  namespace: laseris-website
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
    argocd.argoproj.io/compare-options: IgnoreExtraneous=true
    argocd.argoproj.io/sync-wave: "-1"
subsets:
  - addresses:
      - ip: 83.166.138.23
    ports:
      - port: 443
        name: https
        protocol: TCP

---
# Service for external laseris.ch proxy
apiVersion: v1
kind: Service
metadata:
  name: laseris-ch-external
  namespace: laseris-website
spec:
  ports:
    - port: 443
      name: https
      protocol: TCP

---
# Main Ingress - handles all routes
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: main-ingress
  namespace: laseris-website
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-prod
    traefik.ingress.kubernetes.io/router.entrypoints: web,websecure
    traefik.ingress.kubernetes.io/router.tls: "true"
    traefik.ingress.kubernetes.io/router.middlewares: laseris-website-rate-limit@kubernetescrd,default-redirect-https@kubernetescrd
    traefik.ingress.kubernetes.io/headers.stsSeconds: "31536000"
    traefik.ingress.kubernetes.io/headers.stsIncludeSubdomains: "true"
    traefik.ingress.kubernetes.io/headers.stsPreload: "true"
    traefik.ingress.kubernetes.io/headers.frameDeny: "true"
    traefik.ingress.kubernetes.io/headers.contentTypeNosniff: "true"
spec:
  ingressClassName: traefik
  tls:
    - hosts:
        - laseris.vpr-group.ch
        - dev.laseris.ch
      secretName: laseris-tls-cert
  rules:
    - host: laseris.vpr-group.ch
      http:
        paths:
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: laseris-website-api-service
                port:
                  number: 80

          - path: /admin
            pathType: Prefix
            backend:
              service:
                name: laseris-website-api-service
                port:
                  number: 80

          - path: /_next
            pathType: Prefix
            backend:
              service:
                name: laseris-website-api-service
                port:
                  number: 80

          - path: /__nextjs_original-stack-frame
            pathType: Prefix
            backend:
              service:
                name: laseris-website-api-service
                port:
                  number: 80

          - path: /
            pathType: Prefix
            backend:
              service:
                name: laseris-website-app-service
                port:
                  number: 80
    - host: dev.laseris.ch
      http:
        paths:
          - path: /api
            pathType: Prefix
            backend:
              service:
                name: laseris-website-api-service
                port:
                  number: 80

          - path: /admin
            pathType: Prefix
            backend:
              service:
                name: laseris-website-api-service
                port:
                  number: 80

          - path: /_next
            pathType: Prefix
            backend:
              service:
                name: laseris-website-api-service
                port:
                  number: 80

          - path: /__nextjs_original-stack-frame
            pathType: Prefix
            backend:
              service:
                name: laseris-website-api-service
                port:
                  number: 80

          - path: /
            pathType: Prefix
            backend:
              service:
                name: laseris-website-app-service
                port:
                  number: 80

---
# ServersTransport for external HTTPS proxy
apiVersion: traefik.io/v1alpha1
kind: ServersTransport
metadata:
  name: insecure-transport
  namespace: laseris-website
spec:
  insecureSkipVerify: true
  serverName: laseris.ch

---
# Middleware to rewrite Host header to laseris.ch
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rewrite-host-header
  namespace: laseris-website
spec:
  headers:
    customRequestHeaders:
      Host: laseris.ch
      X-Forwarded-Host: laseris.ch

---
# Rate limiting middleware
# Limits requests to 100 per minute per source IP
apiVersion: traefik.io/v1alpha1
kind: Middleware
metadata:
  name: rate-limit
  namespace: laseris-website
spec:
  rateLimit:
    average: 100
    period: 1m
    burst: 50

---
# IngressRoute for /shop external proxy
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: shop-proxy-route
  namespace: laseris-website
spec:
  entryPoints:
    - web
    - websecure
  routes:
    - match: Host(`laseris.vpr-group.ch`) && PathPrefix(`/shop`)
      kind: Rule
      middlewares:
        - name: rewrite-host-header
      services:
        - name: laseris-ch-external
          kind: Service
          port: 443
          scheme: https
          passHostHeader: true
          serversTransport: insecure-transport
  tls:
    secretName: laseris-tls-cert

---
# IngressRoute for /shop external proxy
apiVersion: traefik.io/v1alpha1
kind: IngressRoute
metadata:
  name: shop-proxy-route-2
  namespace: laseris-website
spec:
  entryPoints:
    - web
    - websecure
  routes:
    - match: Host(`dev.laseris.ch`) && PathPrefix(`/shop`)
      kind: Rule
      middlewares:
        - name: rewrite-host-header
      services:
        - name: laseris-ch-external
          kind: Service
          port: 443
          scheme: https
          passHostHeader: true
          serversTransport: insecure-transport
  tls:
    secretName: laseris-tls-cert
